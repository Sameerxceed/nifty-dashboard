<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nifty Live Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#f0f4f8;--card:#fff;--card2:#f7f9fc;--border:#e2e8f0;
  --text:#1a202c;--text2:#4a5568;--dim:#a0aec0;
  --green:#0a8a4b;--green-bg:#e6f7ef;--red:#c53030;--red-bg:#fff5f5;
  --yellow:#b7791f;--yellow-bg:#fffbeb;--blue:#2b6cb0;--blue-bg:#ebf8ff;
  --accent:#2563eb;
  --shadow:0 1px 3px rgba(0,0,0,0.08);--shadow-md:0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg:0 10px 15px rgba(0,0,0,0.08);--r:12px;--r-sm:8px;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:15px;}

/* HEADER */
.header{background:#fff;border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;background:var(--accent);border-radius:9px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;}
.logo-text{font-size:16px;font-weight:700;}
.logo-sub{font-size:10px;color:var(--dim);}
.header-right{display:flex;align-items:center;gap:8px;}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-blue{background:var(--blue-bg);color:var(--blue);}
.badge-green{display:flex;align-items:center;gap:4px;background:var(--green-bg);color:var(--green);}
.badge-gray{background:var(--card2);color:var(--text2);font-family:'DM Mono',monospace;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(1.3);}}

/* TICKER */
.ticker-wrap{background:#1a202c;overflow:hidden;height:34px;display:flex;align-items:center;}
.ticker-inner{display:flex;animation:ticker 60s linear infinite;white-space:nowrap;}
.ticker-inner:hover{animation-play-state:paused;}
.ticker-item{display:inline-flex;align-items:center;gap:5px;padding:0 16px;font-size:11.5px;font-family:'DM Mono',monospace;}
.ti-name{color:#64748b;}.ti-val{color:#fff;font-weight:500;}.ti-up{color:#4ade80;}.ti-dn{color:#f87171;}
@keyframes ticker{0%{transform:translateX(0);}100%{transform:translateX(-50%);}}

/* MAIN */
.main{padding:16px 20px;max-width:1400px;margin:0 auto;}

/* AI BANNER */
.ai-banner{background:linear-gradient(135deg,#1e3a5f,#2563eb);border-radius:var(--r);padding:16px 20px;margin-bottom:14px;color:#fff;position:relative;overflow:hidden;}
.ai-banner::before{content:'';position:absolute;top:-20px;right:-20px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.05);}
.ai-banner-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.ai-label{font-size:10px;font-weight:700;letter-spacing:1px;opacity:.7;text-transform:uppercase;}
.ai-meta{display:flex;align-items:center;gap:8px;}
.ai-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600;}
.ai-bull{background:rgba(74,222,128,.2);color:#4ade80;}
.ai-bear{background:rgba(248,113,113,.2);color:#f87171;}
.ai-neutral{background:rgba(251,191,36,.2);color:#fbbf24;}
.ai-content{font-size:13px;line-height:1.6;opacity:.95;}
.ai-loading{display:flex;align-items:center;gap:8px;opacity:.7;font-size:12px;}
.ai-dots span{width:5px;height:5px;border-radius:50%;background:#fff;display:inline-block;animation:aidot 1.2s infinite;}
.ai-dots span:nth-child(2){animation-delay:.2s;}.ai-dots span:nth-child(3){animation-delay:.4s;}
@keyframes aidot{0%,80%,100%{transform:scale(0);opacity:.3;}40%{transform:scale(1);opacity:1;}}

/* EOD BANNER */
.eod-banner{background:linear-gradient(135deg,#1c4532,#276749);border-radius:var(--r);padding:14px 20px;margin-bottom:14px;color:#fff;display:none;}
.eod-label{font-size:10px;font-weight:700;letter-spacing:1px;opacity:.7;text-transform:uppercase;margin-bottom:6px;}
.eod-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.eod-item{font-size:12px;opacity:.9;}
.eod-item strong{display:block;font-size:14px;opacity:1;}

/* TOP ROW: Nifty + Pivots + Sentiment */
.top-row{display:grid;grid-template-columns:auto 1fr auto;gap:14px;margin-bottom:14px;align-items:start;}

/* NIFTY MAIN */
.nifty-card{background:var(--card);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);border:1px solid var(--border);min-width:220px;}
.nc-label{font-size:10px;font-weight:700;letter-spacing:1px;color:var(--dim);text-transform:uppercase;margin-bottom:4px;}
.nc-price{font-size:38px;font-weight:700;font-family:'DM Mono',monospace;line-height:1;}
.nc-change{font-size:15px;font-weight:600;margin-top:4px;}
.nc-stats{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;}
.nc-stat{font-size:11px;color:var(--text2);}
.nc-stat span{font-weight:700;color:var(--text);font-family:'DM Mono',monospace;}

/* PIVOT CARD */
.pivot-card{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);border:1px solid var(--border);}
.card-title{font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--dim);margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.pivot-row{display:grid;grid-template-columns:repeat(3,1fr) 1.2fr repeat(3,1fr);gap:6px;}
.pv{border-radius:var(--r-sm);padding:8px 4px;text-align:center;border:1px solid var(--border);}
.pv-lbl{font-size:9px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-bottom:3px;}
.pv-val{font-size:13px;font-weight:700;font-family:'DM Mono',monospace;}
.pv-s3{background:#e2f5e8;border-color:#68d391;}.pv-s3 .pv-lbl,.pv-s3 .pv-val{color:#1c4532;}
.pv-s2{background:#e6f7ef;border-color:#9ae6b4;}.pv-s2 .pv-lbl,.pv-s2 .pv-val{color:#22543d;}
.pv-s1{background:#f0fff4;border-color:#c6f6d5;}.pv-s1 .pv-lbl,.pv-s1 .pv-val{color:#276749;}
.pv-pp{background:#ebf8ff;border-color:#bee3f8;}.pv-pp .pv-lbl,.pv-pp .pv-val{color:#2b6cb0;}
.pv-r1{background:#fffbeb;border-color:#fef3c7;}.pv-r1 .pv-lbl,.pv-r1 .pv-val{color:#b7791f;}
.pv-r2{background:#fff8f5;border-color:#fbd38d;}.pv-r2 .pv-lbl,.pv-r2 .pv-val{color:#c05621;}
.pv-r3{background:#fff5f5;border-color:#fed7d7;}.pv-r3 .pv-lbl,.pv-r3 .pv-val{color:#c53030;}
.pivot-src{font-size:10px;color:var(--dim);margin-top:8px;}

/* SENTIMENT CARD */
.sentiment-card{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);border:1px solid var(--border);min-width:180px;}
.sent-score{font-size:32px;font-weight:700;font-family:'DM Mono',monospace;text-align:center;margin:8px 0 4px;}
.sent-bar-wrap{margin:8px 0;}
.sent-bar{height:7px;border-radius:4px;background:linear-gradient(90deg,#c53030,#fbbf24,#0a8a4b);position:relative;}
.sent-needle{position:absolute;top:-4px;width:14px;height:14px;border-radius:50%;background:#1a202c;border:2px solid #fff;box-shadow:var(--shadow-md);transform:translateX(-50%);transition:left .8s ease;}
.sent-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--dim);margin-top:5px;}
.sent-summary{font-size:11px;color:var(--text2);text-align:center;margin-top:6px;line-height:1.4;}

/* COMPACT ROW: USD/INR, Crude, Gold, VIX, BankNifty */
.compact-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:14px;}
.cmp-card{background:var(--card);border-radius:var(--r-sm);padding:12px 14px;box-shadow:var(--shadow);border:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.cmp-icon{font-size:18px;flex-shrink:0;}
.cmp-data{flex:1;min-width:0;}
.cmp-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);display:flex;align-items:center;gap:3px;}
.cmp-val{font-size:16px;font-weight:700;font-family:'DM Mono',monospace;margin-top:1px;}
.cmp-chg{font-size:11px;font-weight:500;margin-top:1px;}

/* MIDDLE ROW */
.mid-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px;}
.card{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);border:1px solid var(--border);}

/* GLOBAL TABLE */
.gtable{width:100%;border-collapse:collapse;}
.gtable tr{border-bottom:1px solid var(--border);}
.gtable tr:last-child{border-bottom:none;}
.gtable td{padding:8px 4px;font-size:13px;}
.gtable td:first-child{color:var(--text2);font-weight:500;}
.gtable td:nth-child(2){font-family:'DM Mono',monospace;font-weight:600;text-align:right;}
.gtable td:nth-child(3){text-align:right;font-size:11px;font-weight:600;}

/* FII DII */
.fii-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.fii-box{border-radius:var(--r-sm);padding:10px;border:1px solid var(--border);}
.fii-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;}
.fii-row{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;}
.fii-net{display:flex;justify-content:space-between;font-weight:700;font-size:13px;padding-top:6px;border-top:1px solid var(--border);margin-top:4px;}
.sig-badge{display:inline-flex;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-top:8px;}
.fii-source{font-size:10px;color:var(--dim);margin-top:6px;}

/* NEWS */
.news-item{padding:10px 0;border-bottom:1px solid var(--border);}
.news-item:last-child{border-bottom:none;}
.news-tag{display:inline-flex;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;}
.news-hl{font-size:13px;font-weight:600;line-height:1.3;margin-bottom:6px;}
.view-pills{display:flex;gap:6px;}
.vp{padding:3px 8px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;}
.vp-bull{background:var(--green-bg);color:var(--green);}
.vp-nt{background:var(--yellow-bg);color:var(--yellow);}
.vp-bear{background:var(--red-bg);color:var(--red);}
.vp.active{box-shadow:inset 0 0 0 1.5px currentColor;}
.view-txt{font-size:11px;color:var(--text2);margin-top:5px;padding:6px 8px;background:var(--card2);border-radius:5px;display:none;line-height:1.5;}
.view-txt.show{display:block;}

/* 3 VIEW */
.three-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;}
.tv-card{border-radius:var(--r-sm);padding:12px;border:1px solid;}
.tv-bull{background:var(--green-bg);border-color:#9ae6b4;}
.tv-nt{background:var(--yellow-bg);border-color:#fef3c7;}
.tv-bear{background:var(--red-bg);border-color:#feb2b2;}
.tv-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.tv-bull .tv-lbl{color:var(--green);}.tv-nt .tv-lbl{color:var(--yellow);}.tv-bear .tv-lbl{color:var(--red);}
.tv-txt{font-size:12px;line-height:1.5;}

/* OI */
.oi-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.oi-box{border-radius:var(--r-sm);padding:10px;text-align:center;border:1px solid var(--border);background:var(--card2);}
.oi-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:4px;}
.oi-val{font-size:17px;font-weight:700;font-family:'DM Mono',monospace;}
.oi-sub{font-size:10px;color:var(--dim);margin-top:2px;}

/* INFO BTN */
.info-btn{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--border);color:var(--dim);font-size:8px;font-weight:700;cursor:pointer;border:none;transition:all .2s;}
.info-btn:hover{background:var(--accent);color:#fff;}

/* TOOLTIP */
.overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.3);}
.overlay.show{display:block;}
.tmodal{position:fixed;z-index:400;background:var(--card);border-radius:var(--r);padding:18px;max-width:300px;box-shadow:var(--shadow-lg);border:1px solid var(--border);}
.tmodal-title{font-size:14px;font-weight:700;margin-bottom:6px;}
.tmodal-body{font-size:12px;line-height:1.6;color:var(--text2);}
.tmodal-close{position:absolute;top:10px;right:10px;background:var(--card2);border:none;border-radius:5px;width:22px;height:22px;cursor:pointer;font-size:13px;color:var(--dim);}

/* SECTION LABEL */
.sec-label{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* COLORS */
.up{color:var(--green);}.dn{color:var(--red);}.nt{color:var(--yellow);}
.up-bg{background:var(--green-bg);}.dn-bg{background:var(--red-bg);}.nt-bg{background:var(--yellow-bg);}

/* FOOTER */
.footer{text-align:center;padding:16px;font-size:11px;color:var(--dim);}

@media(max-width:900px){
  .top-row{grid-template-columns:1fr;}
  .pivot-row{grid-template-columns:repeat(4,1fr);}
  .compact-row{grid-template-columns:1fr 1fr;}
  .mid-row{grid-template-columns:1fr;}
  .three-grid{grid-template-columns:1fr;}
  .fii-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeTooltip()"></div>
<div class="tmodal" id="tmodal" style="display:none">
  <button class="tmodal-close" onclick="closeTooltip()">‚úï</button>
  <div class="tmodal-title" id="tmodal-title"></div>
  <div class="tmodal-body" id="tmodal-body"></div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">NB</div>
    <div><div class="logo-text">Nifty Live Dashboard</div><div class="logo-sub">Real-time ¬∑ AI Analysis ¬∑ 9-Factor Intelligence</div></div>
  </div>
  <div class="header-right">
    <span class="badge badge-blue" id="session-label">Loading...</span>
    <span class="badge badge-green"><span class="live-dot"></span>LIVE</span>
    <span class="badge badge-gray" id="stamp">--:--:-- IST</span>
  </div>
</div>

<!-- TICKER -->
<div class="ticker-wrap">
  <div class="ticker-inner">
    <div class="ticker-item"><span class="ti-name">NIFTY 50</span><span class="ti-val" id="t-nifty">‚Äî</span><span id="t-nifty-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">BANK NIFTY</span><span class="ti-val" id="t-bank">‚Äî</span><span id="t-bank-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">VIX</span><span class="ti-val" id="t-vix">‚Äî</span><span id="t-vix-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">USD/INR</span><span class="ti-val" id="t-inr">‚Äî</span><span id="t-inr-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">CRUDE</span><span class="ti-val" id="t-crude">‚Äî</span><span id="t-crude-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">GOLD</span><span class="ti-val" id="t-gold">‚Äî</span><span id="t-gold-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">DOW</span><span class="ti-val" id="t-dow">‚Äî</span><span id="t-dow-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">NASDAQ</span><span class="ti-val" id="t-nas">‚Äî</span><span id="t-nas-c">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">NIFTY 50</span><span class="ti-val" id="t-nifty2">‚Äî</span><span id="t-nifty-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">BANK NIFTY</span><span class="ti-val" id="t-bank2">‚Äî</span><span id="t-bank-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">VIX</span><span class="ti-val" id="t-vix2">‚Äî</span><span id="t-vix-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">USD/INR</span><span class="ti-val" id="t-inr2">‚Äî</span><span id="t-inr-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">CRUDE</span><span class="ti-val" id="t-crude2">‚Äî</span><span id="t-crude-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">GOLD</span><span class="ti-val" id="t-gold2">‚Äî</span><span id="t-gold-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">DOW</span><span class="ti-val" id="t-dow2">‚Äî</span><span id="t-dow-c2">‚Äî</span></div>
    <div class="ticker-item"><span class="ti-name">NASDAQ</span><span class="ti-val" id="t-nas2">‚Äî</span><span id="t-nas-c2">‚Äî</span></div>
  </div>
</div>

<div class="main">

  <!-- AI PREDICTION BANNER -->
  <div class="ai-banner">
    <div class="ai-banner-top">
      <span class="ai-label">ü§ñ AI Market Prediction &amp; Brief</span>
      <div class="ai-meta" id="ai-meta"></div>
    </div>
    <div id="ai-content" class="ai-content">
      <div class="ai-loading"><div class="ai-dots"><span></span><span></span><span></span></div> Generating AI market analysis...</div>
    </div>
  </div>

  <!-- EOD BANNER (shown after 3:30pm) -->
  <div class="eod-banner" id="eod-banner">
    <div class="eod-label">üìä End of Day ‚Äî Morning Prediction vs Actual</div>
    <div class="eod-grid">
      <div class="eod-item"><strong id="eod-pred-range">‚Äî</strong>Morning predicted range</div>
      <div class="eod-item"><strong id="eod-actual">‚Äî</strong>Actual close</div>
      <div class="eod-item"><strong id="eod-pred-bias">‚Äî</strong>Predicted bias</div>
      <div class="eod-item"><strong id="eod-verdict">‚Äî</strong>How accurate was AI?</div>
    </div>
  </div>

  <!-- TOP ROW: Nifty | Pivots | Sentiment -->
  <div class="top-row">
    <!-- NIFTY -->
    <div class="nifty-card">
      <div class="nc-label">NIFTY 50 ‚Äî LIVE</div>
      <div class="nc-price" id="nifty-price">‚Äî</div>
      <div class="nc-change" id="nifty-change">‚Äî</div>
      <div class="nc-stats">
        <div class="nc-stat">H: <span id="nifty-high">‚Äî</span></div>
        <div class="nc-stat">L: <span id="nifty-low">‚Äî</span></div>
        <div class="nc-stat">BNF: <span id="bank-val">‚Äî</span></div>
        <div class="nc-stat">VIX: <span id="vix-val">‚Äî</span></div>
      </div>
    </div>

    <!-- PIVOTS -->
    <div class="pivot-card">
      <div class="card-title">üìê Pivot Levels <button class="info-btn" onclick="showInfo('pivots')">i</button></div>
      <div class="pivot-row">
        <div class="pv pv-s3"><div class="pv-lbl">S3</div><div class="pv-val" id="pv-s3">‚Äî</div></div>
        <div class="pv pv-s2"><div class="pv-lbl">S2</div><div class="pv-val" id="pv-s2">‚Äî</div></div>
        <div class="pv pv-s1"><div class="pv-lbl">S1</div><div class="pv-val" id="pv-s1">‚Äî</div></div>
        <div class="pv pv-pp"><div class="pv-lbl">PP</div><div class="pv-val" id="pv-pp">‚Äî</div></div>
        <div class="pv pv-r1"><div class="pv-lbl">R1</div><div class="pv-val" id="pv-r1">‚Äî</div></div>
        <div class="pv pv-r2"><div class="pv-lbl">R2</div><div class="pv-val" id="pv-r2">‚Äî</div></div>
        <div class="pv pv-r3"><div class="pv-lbl">R3</div><div class="pv-val" id="pv-r3">‚Äî</div></div>
      </div>
      <div class="pivot-src" id="pivot-src">Calculated from previous day OHLC</div>
    </div>

    <!-- SENTIMENT -->
    <div class="sentiment-card">
      <div class="card-title" style="justify-content:center;">Sentiment <button class="info-btn" onclick="showInfo('sentiment')">i</button></div>
      <div class="sent-score" id="sent-score">‚Äî</div>
      <div class="sent-bar-wrap">
        <div class="sent-bar"><div class="sent-needle" id="sent-needle" style="left:50%"></div></div>
        <div class="sent-labels"><span>Bear</span><span>Bull</span></div>
      </div>
      <div class="sent-summary" id="sent-label">Calculating...</div>
    </div>
  </div>

  <!-- COMPACT ROW: USD/INR, Crude, Gold, VIX, BankNifty -->
  <div class="compact-row">
    <div class="cmp-card">
      <div class="cmp-icon">üíµ</div>
      <div class="cmp-data">
        <div class="cmp-label">USD/INR <button class="info-btn" onclick="showInfo('usdinr')">i</button></div>
        <div class="cmp-val" id="inr-val">‚Äî</div>
        <div class="cmp-chg" id="inr-chg">‚Äî</div>
      </div>
    </div>
    <div class="cmp-card">
      <div class="cmp-icon">üõ¢Ô∏è</div>
      <div class="cmp-data">
        <div class="cmp-label">CRUDE WTI <button class="info-btn" onclick="showInfo('crude')">i</button></div>
        <div class="cmp-val" id="crude-val">‚Äî</div>
        <div class="cmp-chg" id="crude-chg">‚Äî</div>
      </div>
    </div>
    <div class="cmp-card">
      <div class="cmp-icon">ü•á</div>
      <div class="cmp-data">
        <div class="cmp-label">GOLD <button class="info-btn" onclick="showInfo('gold')">i</button></div>
        <div class="cmp-val" id="gold-val">‚Äî</div>
        <div class="cmp-chg" id="gold-chg">‚Äî</div>
      </div>
    </div>
    <div class="cmp-card">
      <div class="cmp-icon">‚ö°</div>
      <div class="cmp-data">
        <div class="cmp-label">INDIA VIX <button class="info-btn" onclick="showInfo('vix')">i</button></div>
        <div class="cmp-val" id="vix-val2">‚Äî</div>
        <div class="cmp-chg" id="vix-chg">‚Äî</div>
      </div>
    </div>
    <div class="cmp-card">
      <div class="cmp-icon">üè¶</div>
      <div class="cmp-data">
        <div class="cmp-label">BANK NIFTY <button class="info-btn" onclick="showInfo('banknifty')">i</button></div>
        <div class="cmp-val" id="bank-val2">‚Äî</div>
        <div class="cmp-chg" id="bank-chg">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- MIDDLE ROW: Global | FII/DII | OI -->
  <div class="mid-row">
    <div class="card">
      <div class="card-title">üåç Global Markets <button class="info-btn" onclick="showInfo('global')">i</button></div>
      <table class="gtable">
        <tr><td>Dow Jones</td><td id="dow-val">‚Äî</td><td id="dow-chg">‚Äî</td></tr>
        <tr><td>Nasdaq</td><td id="nas-val">‚Äî</td><td id="nas-chg">‚Äî</td></tr>
        <tr><td>Nikkei 225</td><td id="nik-val">‚Äî</td><td id="nik-chg">‚Äî</td></tr>
        <tr><td>Hang Seng</td><td id="hsi-val">‚Äî</td><td id="hsi-chg">‚Äî</td></tr>
        <tr><td>FTSE 100</td><td id="ftse-val">‚Äî</td><td id="ftse-chg">‚Äî</td></tr>
      </table>
    </div>

    <div class="card">
      <div class="card-title">üè¶ FII + DII Flows <button class="info-btn" onclick="showInfo('fiidii')">i</button>
        <span style="font-size:9px;color:var(--dim);margin-left:auto;font-weight:400;" id="fii-date"></span>
      </div>
      <div id="fiidii-content"><div style="color:var(--dim);font-size:12px;">Loading...</div></div>
    </div>

    <div class="card">
      <div class="card-title">üìä Options OI Data <button class="info-btn" onclick="showInfo('oi')">i</button></div>
      <div class="oi-grid">
        <div class="oi-box"><div class="oi-lbl">Max Pain</div><div class="oi-val" id="oi-maxpain">‚Äî</div><div class="oi-sub">Strike</div></div>
        <div class="oi-box"><div class="oi-lbl">PCR <button class="info-btn" onclick="showInfo('pcr')">i</button></div><div class="oi-val" id="oi-pcr">‚Äî</div><div class="oi-sub" id="oi-pcr-sig">‚Äî</div></div>
        <div class="oi-box"><div class="oi-lbl">Max CE OI</div><div class="oi-val up" id="oi-ce">‚Äî</div><div class="oi-sub">Resistance</div></div>
      </div>
      <div style="margin-top:12px;">
        <div class="card-title">üì∞ Breaking News <button class="info-btn" onclick="showInfo('news')">i</button></div>
        <div id="news-container"><div style="color:var(--dim);font-size:12px;">Loading AI data...</div></div>
      </div>
    </div>
  </div>

  <!-- 3-VIEW -->
  <div class="card" style="margin-bottom:14px;">
    <div class="card-title">üî≠ 3-View Analysis ‚Äî Key Event <button class="info-btn" onclick="showInfo('threeview')">i</button></div>
    <div id="three-view"><div style="color:var(--dim);font-size:12px;">Loading AI data...</div></div>
  </div>

  <div class="footer">
    Nifty Live Dashboard ¬∑ Yahoo Finance + NSE data ¬∑ AI via Gemini ¬∑
    <span id="footer-stamp"></span> ¬∑ Not financial advice
  </div>
</div>

<script>
(function(){
"use strict";

const API_URL    = "https://nifty-api.vercel.app/api/quotes";
const GEMINI_URL = "https://nifty-api.vercel.app/api/gemini";
const NSE_FII    = "https://api.allorigins.win/get?url=" + encodeURIComponent("https://www.nseindia.com/api/fiidiiTradeReact");

// INFO TOOLTIPS
const INFO = {
  banknifty:["Bank Nifty","Index of 12 most liquid banking stocks. Highly sensitive to RBI policy and interest rates. Strong Bank Nifty confirms broader market strength; weakness signals sector stress."],
  vix:["India VIX","Expected volatility over 30 days. VIX < 12 = Low fear. VIX 12-16 = Normal. VIX > 20 = High fear. Very high VIX often marks market bottoms ‚Äî contrarian buy signal."],
  sentiment:["Market Sentiment Score","Composite 0-100 score. >60 = Bullish. 40-60 = Neutral. <40 = Bearish. Based on FII flows, global cues, VIX, and technicals."],
  usdinr:["USD/INR Rate","Rupee weakness (higher number) raises import costs and may trigger FII outflows. Stable/strong rupee is positive for markets."],
  crude:["Crude Oil WTI","India imports 85% of oil. Rising crude increases inflation, weakens rupee, compresses margins. Below $75 is positive. Above $90 is a headwind."],
  gold:["Gold","Safe-haven asset. Gold rising sharply = risk-off sentiment = negative for equities. But moderate gold rise = inflation hedge, neutral for markets."],
  global:["Global Markets","Nifty is highly correlated with US markets. Positive US close = tailwind for Nifty. Watch Nasdaq for tech sentiment, Nikkei/Hang Seng for Asian cues."],
  fiidii:["FII & DII Flows","FII (Foreign) net buying = bullish, selling = bearish. DII (Domestic funds) often counter-trade FIIs ‚Äî buy when FIIs sell, acting as market cushion."],
  pivots:["Pivot Points","Support/Resistance from previous day H/L/C. PP = neutral. S1-S3 = supports below (green). R1-R3 = resistances above (red). Strong reactions expected at these levels."],
  oi:["Open Interest Data","Max Pain = strike where most options expire worthless. PCR > 1.2 = Bullish. PCR < 0.8 = Bearish. Max CE OI = strong resistance level."],
  pcr:["Put-Call Ratio","PCR > 1.5 = Extremely bullish. 1.0-1.3 = Mildly bullish. 0.7-1.0 = Neutral/bearish. < 0.7 = Bearish (excessive call buying often signals a top)."],
  news:["Breaking News + 3 Views","Each news analyzed from 3 angles: üü¢ Bull = positive interpretation, üü° Neutral = balanced take, üî¥ Bear = risk view. Click pills to expand."],
  threeview:["3-View Analysis","Deep-dive on today's key market event. Three distinct perspectives help you form your own informed trading bias."],
};

function showInfo(key){
  const [t,b]=INFO[key]||["Info","No data."];
  document.getElementById("tmodal-title").textContent=t;
  document.getElementById("tmodal-body").textContent=b;
  const m=document.getElementById("tmodal");
  m.style.cssText="display:block;top:50%;left:50%;transform:translate(-50%,-50%);";
  document.getElementById("overlay").classList.add("show");
}
function closeTooltip(){
  document.getElementById("tmodal").style.display="none";
  document.getElementById("overlay").classList.remove("show");
}

const $=id=>document.getElementById(id);
const set=(id,v)=>{const e=$(id);if(e)e.textContent=v;};
const setH=(id,v)=>{const e=$(id);if(e)e.innerHTML=v;};
function fmt(n,d=2){if(n==null||isNaN(n))return"‚Äî";return Number(n).toLocaleString("en-IN",{minimumFractionDigits:d,maximumFractionDigits:d});}
function fmtC(n){if(n==null||isNaN(n))return"‚Äî";return(n>=0?"+":"")+fmt(n,2);}
function fmtP(n){if(n==null||isNaN(n))return"‚Äî%";return(n>=0?"+":"")+fmt(n,2)+"%";}
function col(n){return n>0?"up":n<0?"dn":"nt";}
function colStyle(n){return n>0?"color:var(--green)":n<0?"color:var(--red)":"color:var(--yellow)";}

// IST helpers
function getIST(){
  const p=f=>parseInt(new Date().toLocaleString("en-IN",{timeZone:"Asia/Kolkata",...f}));
  const h=p({hour:"2-digit",hour12:false}),m=p({minute:"2-digit"}),s=p({second:"2-digit"});
  const day=new Date().toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata",weekday:"short"});
  return{h,m,s,t:h*60+m,isWeekend:day==="Sun"||day==="Sat"};
}
function isMarket(){const{t,isWeekend}=getIST();return !isWeekend&&t>=9*60+15&&t<=15*60+30;}
function isAfterMarket(){const{t}=getIST();return t>15*60+30;}

function updateStamp(){
  const now=new Date();
  const ts=now.toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false});
  const ds=now.toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata",day:"2-digit",month:"short",year:"numeric"});
  set("stamp",ts+" IST");
  set("footer-stamp","Updated "+ts+" ¬∑ "+ds);
}

function getSession(){
  const{t}=getIST();
  if(t<8*60)return"Pre-Market";
  if(t<9*60+15)return"Morning Brief 8:00 AM";
  if(t<11*60+15)return"Market Open 9:15 AM";
  if(t<13*60+15)return"Mid-Morning 11:15 AM";
  if(t<15*60+15)return"Post-Lunch 1:15 PM";
  if(t<15*60+45)return"Pre-Close 3:15 PM";
  return"After Market";
}

// PIVOT CALC
function calcPivots(h,l,c){
  const pp=(h+l+c)/3;
  return{pp,r1:2*pp-l,s1:2*pp-h,r2:pp+(h-l),s2:pp-(h-l),r3:h+2*(pp-l),s3:l-2*(h-pp)};
}
function renderPivots(h,l,c){
  const p=calcPivots(h,l,c);
  set("pv-r3",fmt(p.r3,0));set("pv-r2",fmt(p.r2,0));set("pv-r1",fmt(p.r1,0));
  set("pv-pp",fmt(p.pp,0));
  set("pv-s1",fmt(p.s1,0));set("pv-s2",fmt(p.s2,0));set("pv-s3",fmt(p.s3,0));
  set("pivot-src","Prev H:"+fmt(h,0)+" L:"+fmt(l,0)+" C:"+fmt(c,0));
}

// FETCH QUOTES
async function fetchQuotes(){
  try{
    const r=await fetch(API_URL+"?t="+Date.now(),{mode:"cors"});
    if(!r.ok)throw 0;
    const d=await r.json();
    if(d.ok&&d.quotes&&d.quotes.length)return d.quotes;
  }catch(e){}
  return[];
}

function updateMarket(quotes){
  const by=sym=>quotes.find(q=>q.symbol===sym||q.symbol===sym.replace("^","%5E"));
  const nifty=by("^NSEI")||quotes.find(q=>q.symbol&&q.symbol.includes("NSEI")&&!q.symbol.includes("BANK"));
  const bank=by("^NSEBANK")||quotes.find(q=>q.symbol&&q.symbol.includes("NSEBANK"));
  const vix=by("^INDIAVIX")||quotes.find(q=>q.symbol&&q.symbol.includes("INDIAVIX"));
  const inr=by("USDINR=X")||quotes.find(q=>q.symbol&&q.symbol.includes("USDINR"));
  const crude=by("CL=F")||quotes.find(q=>q.symbol&&q.symbol.includes("CL"));
  const gold=by("GC=F")||quotes.find(q=>q.symbol&&q.symbol.includes("GC"));
  const dow=by("^DJI")||quotes.find(q=>q.symbol&&q.symbol.includes("DJI"));
  const nas=by("^IXIC")||quotes.find(q=>q.symbol&&q.symbol.includes("IXIC"));
  const nik=by("^N225")||quotes.find(q=>q.symbol&&q.symbol.includes("N225"));
  const hsi=by("^HSI")||quotes.find(q=>q.symbol&&q.symbol.includes("HSI"));
  const ftse=by("^FTSE")||quotes.find(q=>q.symbol&&q.symbol.includes("FTSE"));

  const gp=q=>q.price||q.regularMarketPrice;
  const gc=q=>q.change||q.regularMarketChange;
  const gcp=q=>q.changePct||q.regularMarketChangePercent;
  const gh=q=>q.high||q.regularMarketDayHigh;
  const gl=q=>q.low||q.regularMarketDayLow;
  const gpc=q=>q.prevClose||q.regularMarketPreviousClose;

  if(nifty){
    const c=col(gc(nifty));
    const ep=$(  "nifty-price");if(ep){ep.textContent=fmt(gp(nifty),2);ep.className="nc-price "+c;}
    const ec=$("nifty-change");if(ec){ec.textContent=fmtC(gc(nifty))+" ("+fmtP(gcp(nifty))+")";ec.style=colStyle(gc(nifty));}
    set("nifty-high",fmt(gh(nifty),2));set("nifty-low",fmt(gl(nifty),2));
    // Store for EOD
    window._niftyClose = gp(nifty);
    // Pivots from live data
    if(gh(nifty)&&gl(nifty)&&gpc(nifty)) renderPivots(gh(nifty),gl(nifty),gpc(nifty));
  }
  if(bank){
    set("bank-val",fmt(gp(bank),0));set("bank-val2",fmt(gp(bank),2));
    const bc=$("bank-chg");if(bc){bc.textContent=fmtC(gc(bank))+" ("+fmtP(gcp(bank))+")";bc.style=colStyle(gc(bank));}
  }
  if(vix){
    const vp=gp(vix);
    set("vix-val",fmt(vp,2));set("vix-val2",fmt(vp,2));
    const vc=$("vix-chg");if(vc){vc.textContent=fmtC(gc(vix))+" ("+fmtP(gcp(vix))+")";vc.style=colStyle(gc(vix));}
  }
  if(inr){
    set("inr-val","‚Çπ"+fmt(gp(inr),2));
    const ic=$("inr-chg");if(ic){ic.textContent=fmtC(gc(inr))+" ("+fmtP(gcp(inr))+")";ic.style=colStyle(gc(inr));}
  }
  if(crude){
    set("crude-val","$"+fmt(gp(crude),2));
    const cc=$("crude-chg");if(cc){cc.textContent=fmtC(gc(crude))+" ("+fmtP(gcp(crude))+")";cc.style=colStyle(gc(crude));}
  }
  if(gold){
    set("gold-val","$"+fmt(gp(gold),2));
    const gc2=$("gold-chg");if(gc2){gc2.textContent=fmtC(gc(gold))+" ("+fmtP(gcp(gold))+")";gc2.style=colStyle(gc(gold));}
  }

  // Ticker (duplicate for seamless loop)
  const tp=[[nifty,"t-nifty","t-nifty-c","t-nifty2","t-nifty-c2"],[bank,"t-bank","t-bank-c","t-bank2","t-bank-c2"],
    [vix,"t-vix","t-vix-c","t-vix2","t-vix-c2"],[inr,"t-inr","t-inr-c","t-inr2","t-inr-c2"],
    [crude,"t-crude","t-crude-c","t-crude2","t-crude-c2"],[gold,"t-gold","t-gold-c","t-gold2","t-gold-c2"],
    [dow,"t-dow","t-dow-c","t-dow2","t-dow-c2"],[nas,"t-nas","t-nas-c","t-nas2","t-nas-c2"]];
  for(const[q,v1,c1,v2,c2]of tp){
    if(!q)continue;
    set(v1,fmt(gp(q),2));set(v2,fmt(gp(q),2));
    const mkC=id=>{const e=$(id);if(e){e.textContent=fmtC(gc(q))+" ("+fmtP(gcp(q))+")";e.className=gc(q)>=0?"ti-up":"ti-dn";}};
    mkC(c1);mkC(c2);
  }

  // Global table
  for(const[pfx,q]of[["dow",dow],["nas",nas],["nik",nik],["hsi",hsi],["ftse",ftse]]){
    if(!q)continue;
    set(pfx+"-val",fmt(gp(q),2));
    const ce=$(pfx+"-chg");if(ce){ce.textContent=fmtC(gc(q))+" ("+fmtP(gcp(q))+")";ce.style=colStyle(gc(q));}
  }
}

// FII/DII via NSE (direct, no AI needed)
async function fetchFIIDII(){
  try{
    const r=await fetch(NSE_FII,{mode:"cors"});
    if(!r.ok)throw 0;
    const wrapper=await r.json();
    const data=JSON.parse(wrapper.contents);
    const today=data[0];
    if(!today)throw 0;
    const fii={buy:today.fiiBuy||today.fii_buy||"‚Äî",sell:today.fiiSell||today.fii_sell||"‚Äî",net:today.fiiNet||today.fii_net||"‚Äî"};
    const dii={buy:today.diiBuy||today.dii_buy||"‚Äî",sell:today.diiSell||today.dii_sell||"‚Äî",net:today.diiNet||today.dii_net||"‚Äî"};
    const date=today.date||today.tradedDate||"Today";
    set("fii-date",date);
    renderFIIDII(fii,dii);
    return;
  }catch(e){console.warn("NSE FII direct fetch failed:",e.message);}
  // Fallback to AI
  fetchFIIFromAI();
}

function fetchFIIFromAI(){
  // Will be populated when AI call completes
  setH("fiidii-content",'<div style="color:var(--dim);font-size:12px;">Fetching from AI...</div>');
}

function renderFIIDII(fii,dii){
  const fnet=parseFloat((fii.net+"").replace(/,/g,""))||0;
  const dnet=parseFloat((dii.net+"").replace(/,/g,""))||0;
  const sig=fnet>0&&dnet>0?"both_buying":fnet<0&&dnet<0?"both_selling":"mixed";
  const sigCls=sig==="both_buying"?"up-bg up":sig==="both_selling"?"dn-bg dn":"nt-bg nt";
  const sigTxt=sig==="both_buying"?"BOTH BUYING üü¢":sig==="both_selling"?"BOTH SELLING üî¥":"MIXED üü°";
  setH("fiidii-content",`
    <div class="fii-grid">
      <div class="fii-box">
        <div class="fii-title" style="color:var(--blue)">FII (Foreign)</div>
        <div class="fii-row"><span style="color:var(--dim)">Buy</span><span class="up">‚Çπ${fii.buy} Cr</span></div>
        <div class="fii-row"><span style="color:var(--dim)">Sell</span><span class="dn">‚Çπ${fii.sell} Cr</span></div>
        <div class="fii-net"><span>Net</span><span style="${colStyle(fnet)}">‚Çπ${fii.net} Cr</span></div>
      </div>
      <div class="fii-box">
        <div class="fii-title" style="color:var(--accent)">DII (Domestic)</div>
        <div class="fii-row"><span style="color:var(--dim)">Buy</span><span class="up">‚Çπ${dii.buy} Cr</span></div>
        <div class="fii-row"><span style="color:var(--dim)">Sell</span><span class="dn">‚Çπ${dii.sell} Cr</span></div>
        <div class="fii-net"><span>Net</span><span style="${colStyle(dnet)}">‚Çπ${dii.net} Cr</span></div>
      </div>
    </div>
    <div class="sig-badge ${sigCls}">${sigTxt}</div>
    <div class="fii-source">Source: NSE India (cash market)</div>
  `);
}

// GEMINI
async function callGemini(prompt,json=false){
  try{
    const r=await fetch(GEMINI_URL,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt,json})});
    if(!r.ok){const e=await r.json();console.error("Gemini proxy error:",r.status,e);return null;}
    const d=await r.json();
    if(!d.ok||!d.text){console.error("Gemini empty:",d);return null;}
    console.log("Gemini OK ("+d.model+"), len:",d.text.length);
    return d.text;
  }catch(e){console.error("Gemini error:",e.message);return null;}
}

function parseJSON(raw){
  if(!raw)return null;
  try{
    let c=raw.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();
    const m=c.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
    if(!m)return null;
    return JSON.parse(m[1]);
  }catch(e){
    try{const s=raw.search(/[\[{]/);if(s===-1)return null;const sub=raw.slice(s);const end=Math.max(sub.lastIndexOf("}"),sub.lastIndexOf("]"))+1;return JSON.parse(sub.slice(0,end));}
    catch(e2){return null;}
  }
}

async function fetchAIData(){
  const now=new Date();
  const today=now.toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata",weekday:"long",day:"2-digit",month:"long",year:"numeric"});
  const time=now.toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata",hour:"2-digit",minute:"2-digit",hour12:false});
  console.log("Fetching AI for:",today,time);

  const combined=await callGemini(
    `You are a Nifty 50 market analyst. The current date/time is ${today}, ${time} IST (this is TODAY, not a future date). Provide real analysis based on current market conditions.
Return ONLY this JSON (no other text):
{
  "news":[{"tag":"MARKET","headline":"","impact":"positive","bull":"","neutral":"","bear":""},{"tag":"MACRO","headline":"","impact":"neutral","bull":"","neutral":"","bear":""},{"tag":"GEO","headline":"","impact":"negative","bull":"","neutral":"","bear":""}],
  "oi":{"max_pain":"25000","pcr":"1.1","top_ce_strike":"25500"},
  "sentiment":{"score":50,"label":"Neutral","summary":"Brief one-line sentiment summary"},
  "perspectives":{"key_event":"Key event headline","bull_view":"Bullish case with target","neutral_view":"Balanced range view","bear_view":"Bearish risk with support"},
  "brief":"OPENING: context. KEY LEVELS: levels to watch. FII: flow direction. GLOBAL: cues impact. VERDICT: today's bias with reasoning.",
  "morning_range":{"low":"24800","high":"25200","bias":"Bullish"}
}`, true);

  const d=parseJSON(combined);
  if(d){
    console.log("AI combined OK");
    if(d.news)renderNews(d.news);
    if(d.oi)renderOI(d.oi);
    if(d.sentiment)renderSentiment(d.sentiment);
    if(d.perspectives)renderPerspectives(d.perspectives);
    if(d.brief)renderBrief(d.brief,d.sentiment,d.morning_range);
    // Store morning prediction for EOD
    if(d.morning_range) window._morningPred=d.morning_range;
    // If FII not loaded from NSE, use AI fallback
    if(d.fiidii) renderFIIDII(d.fiidii.fii,d.fiidii.dii);
  } else {
    const text=await callGemini(`Nifty 50 market analysis for ${today} ${time} IST. Opening context, key levels, FII trend, global cues, trading verdict. 100 words.`,false);
    if(text)renderBrief(text,null,null);
  }
}

function renderBrief(text,sentiment,range){
  if(!text){setH("ai-content",'<span style="opacity:.6">AI brief unavailable</span>');return;}
  const formatted=text.replace(/\n/g,"<br>").replace(/([A-Z][A-Z\s]+):/g,'<strong>$1:</strong>');
  setH("ai-content",formatted);
  // Sentiment pill
  if(sentiment){
    const sc=parseInt(sentiment.score)||50;
    const cls=sc>60?"ai-bull":sc<40?"ai-bear":"ai-neutral";
    const icon=sc>60?"üü¢":sc<40?"üî¥":"üü°";
    setH("ai-meta",`<span class="ai-pill ${cls}">${icon} ${sentiment.label||"Neutral"} ¬∑ ${sc}/100</span>`+(range?`<span style="font-size:10px;opacity:.7;margin-left:6px;">Range: ${range.low}‚Äì${range.high}</span>`:""));
  }
  // EOD check
  updateEOD();
}

function renderSentiment(d){
  if(!d)return;
  const sc=parseInt(d.score)||50;
  set("sent-score",sc+"/100");
  const n=$("sent-needle");if(n)n.style.left=sc+"%";
  set("sent-label",(d.label||"Neutral")+": "+(d.summary||""));
}

function renderNews(items){
  if(!items||!items.length){setH("news-container",'<span style="color:var(--dim);font-size:11px">Unavailable</span>');return;}
  const tagC={"MARKET":"background:#ebf8ff;color:#2b6cb0","MACRO":"background:#f0fff4;color:#276749","GEO":"background:#fff5f5;color:#c53030","SECTOR":"background:#faf5ff;color:#6b46c1"};
  setH("news-container",items.slice(0,3).map((it,i)=>`
    <div class="news-item">
      <span class="news-tag" style="${tagC[it.tag]||tagC.MARKET}">${it.tag||"NEWS"}</span>
      <div class="news-hl">${it.headline||""}</div>
      <div class="view-pills">
        ${it.bull?`<span class="vp vp-bull" onclick="toggleView(this,'bv${i}')">üü¢ Bull</span>`:""}
        ${it.neutral?`<span class="vp vp-nt" onclick="toggleView(this,'nv${i}')">üü° Neutral</span>`:""}
        ${it.bear?`<span class="vp vp-bear" onclick="toggleView(this,'bev${i}')">üî¥ Bear</span>`:""}
      </div>
      ${it.bull?`<div class="view-txt" id="bv${i}">${it.bull}</div>`:""}
      ${it.neutral?`<div class="view-txt" id="nv${i}">${it.neutral}</div>`:""}
      ${it.bear?`<div class="view-txt" id="bev${i}">${it.bear}</div>`:""}
    </div>`).join(""));
}

function toggleView(btn,id){
  const el=$(id);if(!el)return;
  const show=el.classList.contains("show");
  btn.closest(".news-item").querySelectorAll(".view-txt").forEach(e=>e.classList.remove("show"));
  btn.closest(".news-item").querySelectorAll(".vp").forEach(e=>e.classList.remove("active"));
  if(!show){el.classList.add("show");btn.classList.add("active");}
}

function renderOI(d){
  if(!d)return;
  set("oi-maxpain",d.max_pain||"‚Äî");
  const pcr=parseFloat(d.pcr)||0;
  set("oi-pcr",d.pcr||"‚Äî");
  const ps=$("oi-pcr-sig");if(ps){ps.textContent=pcr>1.2?"Bullish":pcr<0.8?"Bearish":"Neutral";ps.style=pcr>1.2?"color:var(--green)":pcr<0.8?"color:var(--red)":"color:var(--yellow)";}
  set("oi-ce",d.top_ce_strike||"‚Äî");
}

function renderPerspectives(d){
  if(!d||!d.key_event){setH("three-view",'<span style="color:var(--dim);font-size:12px">Data pending</span>');return;}
  setH("three-view",`
    <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px;">üìå ${d.key_event}</div>
    <div class="three-grid">
      <div class="tv-card tv-bull"><div class="tv-lbl">üü¢ Bull View</div><div class="tv-txt">${d.bull_view||""}</div></div>
      <div class="tv-card tv-nt"><div class="tv-lbl">üü° Neutral View</div><div class="tv-txt">${d.neutral_view||""}</div></div>
      <div class="tv-card tv-bear"><div class="tv-lbl">üî¥ Bear View</div><div class="tv-txt">${d.bear_view||""}</div></div>
    </div>`);
}

// EOD COMPARISON
function updateEOD(){
  if(!isAfterMarket())return;
  const banner=$("eod-banner");if(!banner)return;
  banner.style.display="block";
  const pred=window._morningPred;
  const close=window._niftyClose;
  if(pred){
    set("eod-pred-range",pred.low+"‚Äì"+pred.high);
    set("eod-pred-bias",pred.bias||"‚Äî");
  }
  if(close){
    set("eod-actual",fmt(close,2));
    if(pred){
      const inRange=close>=parseFloat(pred.low)&&close<=parseFloat(pred.high);
      set("eod-verdict",inRange?"‚úÖ Within predicted range":"‚ö†Ô∏è Outside predicted range");
    }
  }
}

// MAIN LOOP
let aiLoaded=false;
async function poll(){
  updateStamp();
  set("session-label",getSession());
  const quotes=await fetchQuotes();
  if(quotes.length)updateMarketData(quotes);
  if(!aiLoaded){
    aiLoaded=true;
    fetchFIIDII();
    fetchAIData().catch(e=>console.error("AI error:",e));
  }
  updateEOD();
  setTimeout(poll,isMarket()?60000:300000);
}

function updateMarketData(q){updateMarket(q);}
setInterval(updateStamp,1000);
window.addEventListener("DOMContentLoaded",poll);
window.toggleView=toggleView;
window.showInfo=showInfo;
window.closeTooltip=closeTooltip;
})();
</script>
</body>
</html>
